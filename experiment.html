<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLT</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-call-function.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="plugin-PLT.js"></script>
    <script src="instructions.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .jsPsychDE {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: whitesmoke;
    }
</style>
<body>
    <div id='display_element' class='jsPsychDE'></div>
</body>
<script>
    // SET UP MULTIPLE IMAGE LISTS AND OUTCOME LISTS FOR DIFFERENT CONDITIONS HERE
    const leftimgList = ['balloon1.png','balloon1.png','bowtie1.png','balloon1.png','balloon1.png','bowtie1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','balloon1.png',
    'bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png',
    'hourglass1.png','scrunchie2.png','snowglobe1.png','hourglass2.png','snowglobe2.png','rug1.png','rug2.png',
    'easteregg1.png','coatrack1.png','easteregg2.png','cushion1.png','coatrack2.png','cushion2.png',
    'necktie1.png','necktie2.png','coffeemug1.png','chessboard1.png','coffeemug2.png','balloon2.png','chessboard2.png'];
    const rightimgList = ['bowtie1.png','bowtie1.png','balloon1.png','bowtie1.png','bowtie1.png','balloon1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','bowtie1.png',
    'scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png',
    'hourglass1.png','scrunchie2.png','snowglobe1.png','hourglass2.png','snowglobe2.png','rug1.png','rug2.png',
    'easteregg1.png','coatrack1.png','easteregg2.png','cushion1.png','coatrack2.png','cushion2.png',
    'necktie1.png','necktie2.png','coffeemug1.png','chessboard1.png','coffeemug2.png','balloon2.png','chessboard2.png'];
    const leftoutcomeList = [1,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01];
    const rightoutcomeList = [0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,1];
    const totalTrialNumber = 312; // 12 (blocks) * 13 (trials) * 2 (reward/punishment conditions)
    window.totalBlockNumber = 24;
    // get PID
    // var PID = ;
    
    // ASSIGN CONDITIONS HERE BASED ON PID; 1 is no early stop & reward-punishment grouped, 2 is no early stop & punishment-reward grouped, 
    //                                      3 is early stop & reward-punishment grouped, 4 is early stop & punishment-reward grouped, 
    //                                      5 is no early stop & interleaved, 6 is early stop & interleaved

    // Conditions:
    // First digit - early stopping. 0 - no early stopping, 1 - early stopping
    // Second digit - valence grouped / interleaved. 0 - interleaved, 1 - grouped.
    // Third digit - reward first. 0 - punishment first, 1 - reward first, undefined - NA

    async function load_squences(condition, session) {
        try {
            const response = await fetch('PLT_task_structure_' + condition + '.json');
            if (!response.ok) {
            throw new Error('Network response was not ok');
            }
            const data = await response.json()[session - 1];
            console.log(data); // Handle the JSON data
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }

    // Initialize jsPysch object
    let jsPsych = initJsPsych({
        display_element: 'display_element',
    });

    // Get condition from URL, all caps are prolific, lowercase are ours
    window.condition = jsPsych.data.getURLVariable('cond');
    window.prolificPID = jsPsych.data.getURLVariable('PROLIFIC_PID');
    window.studyId = jsPsych.data.getURLVariable('STUDY_ID');
    window.sessionId = jsPsych.data.getURLVariable('SESSION_ID');
    window.sessionNum = jsPsych.data.getURLVariable('session_num');

    // Parse condition
    window.earlyStop = window.condition[0] == "1"
    window.valenceGrouped = window.condition[1] == "1"
    window.rewardFirst = window.condition[2] == "1"

    // Save participant variables to data
    jsPsych.data.addProperties({
        prolific_pid: window.prolificPID,
        study_id: window.studyId,
        session_id: window.sessionId,
        condition: window.condition,
        early_stop: window.earlyStop,
        valence_grouped: window.valenceGrouped,
        reward_first: window.rewardFirst
    })

    load_squences(window.condition, window.sessionNum);

    window.skipThisBlock = false;
    window.accNumber = 0;
    window.blockNumber = 1;
    window.interimOutcome = 0;
    
    let instructions = prepare_instructions()

    function make_bandit_trial(leftimage, rightimage, leftoutcome, rightoutcome) {
        return {
            timeline: [{
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<div style="font-size:60px">+</div>',
                choices: "NO_KEYS",
                trial_duration: 800,
                data: {trialphase: "fixation"},
            },{
                type: jsPsychPLT,
                imgLeft: function() {'imgs/'+ jsPsych.timelineVariable('stimulus_left')},
                imgRight: function() {'imgs/'+ jsPsych.timelineVariable('stimulus_right')},
                outcomeLeft: jsPsych.timelineVariable('feedback_left'),
                outcomeRight: jsPsych.timelineVariable('feedback_left'),
                optimalRight: jsPsych.timelineVariable('optimal_right'),
                data: {
                    trialphase: "task",
                },
                on_finish: function(data) {
                    if (data.isOptimal) {
                        window.accNumber++;
                    } else {
                        window.accNumber = 0;
                    }
                    if (window.accNumber === 5){
                        if (earlyStop){
                            window.skipThisBlock = true
                        }
                    }
                    data.blockNumber = window.blockNumber;
                    window.interimOutcome = window.interimOutcome + data.chosenOutcome;
                    console.log(window.accNumber)
                }
            }
            ],
            conditional_function: function(){
                return !window.skipThisBlock
            }
        }
    } 

    function draw_break(){
        if (!earlyStop) {
            return {
                timeline:[{
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "New round! You will see two new cards!",
                    data: {
                        trialphase: "break",
                    },
                    on_finish: (data)=>{
                        data.earlybreak = window.skipThisBlock;
                        data.blockNumber = window.blockNumber;
                        window.blockNumber++; 
                    },
                }]
            }
        } else if (earlyStop){
            return {
                timeline:[{
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: ()=>{
                        if (window.skipThisBlock){
                            return "You've clearly identified the optimal card.<br><br>You will now see two new cards.<br><br>Press S key to continue.";
                            // return `<p>You've clearly identified the optimal card. You have obtained ${window.interimOutcome} points.<br><br>You will now see two new cards.<br><br>Press S key to continue.</p>`;
                        } else {
                            return "New round! You will see two new cards.";
                        }
                    },
                    data: {
                        trialphase: "break",
                    },
                    on_finish: function(data){
                        data.earlybreak = window.skipThisBlock;
                        window.skipThisBlock = false;
                        window.accNumber = 0;
                        data.blockNumber = window.blockNumber;
                        window.blockNumber++;
                        window.interimOutcome = 0;
                    }
                }]
            }
        }
    }
    
    let bandit_block = [];
    let trialNumber = 0;
    for (let i = 0; i < totalTrialNumber; i++){
        let leftimage = leftimgList.shift();
        let rightimage = rightimgList.shift();
        let leftoutcome = leftoutcomeList.shift();
        let rightoutcome = rightoutcomeList.shift();
        trialNumber ++;

        bandit_block.push(make_bandit_trial(leftimage, rightimage, leftoutcome, rightoutcome));
        
        if (trialNumber % 13 ==0) {
            bandit_block.push(draw_break());
        }
        // new instructions for the grouped conditions
        if ((trialNumber) === 156) {
            if (window.condition === "011") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of taking away your coins in this game.<br><br>Your goal is to figure out which of the two cards COSTS you the most coins, and AVOID LOSING the coins as best as your can over time.<br><br>Upon your selection, you will see a picture of a broken coin, indicating the amount you have lost from that selection.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            } else if (window.condition === "111") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of taking away your coins in this game.<br><br>Your goal is to figure out which of the two cards COSTS you the most coins, and AVOID LOSING the coins as best as your can over time.<br><br>Upon your selection, you will see a picture of a broken coin, indicating the amount you have lost from that selection.<br><br>If you choose the better card five times in a row within a round, you will be able to skip to the next round of game immediately.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            } else if (window.condition === "010") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of giving you coins.<br><br>Your goal is to figure out which of the two cards GIVES you the most coins, and COLLECT as many coins as possible over time.<br><br>Upon your selection, you will see a picture of a coin, indicating the amount you have earned from that selection.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            } else if (window.condition === "110") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of giving you coins.<br><br>Your goal is to figure out which of the two cards GIVES you the most coins, and COLLECT as many coins as possible over time.<br><br>Upon your selection, you will see a picture of a coin, indicating the amount you have earned from that selection.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            }
        }
    }
    
    let procedure = [];
    procedure = procedure.concat(instructions);
    procedure.push({ timeline: bandit_block});
    procedure.push({                
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Well done! You have finished the experiment.",
        data: {trialphase: "end"},
        on_start: () => {
            jsPsych.data.get().localSave('csv', `PLT_data.csv`);
        }
    })

    jsPsych.run(procedure);
    
</script>
</html>