<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLT</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-call-function.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="plugin-PLT.js"></script>
    <script src="instructions.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .jsPsychDE {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: whitesmoke;
    }
</style>
<body>
    <div id='display_element' class='jsPsychDE'></div>
</body>
<script>
    // SET UP MULTIPLE IMAGE LISTS AND OUTCOME LISTS FOR DIFFERENT CONDITIONS HERE
    const leftimgList = ['balloon1.png','balloon1.png','bowtie1.png','balloon1.png','balloon1.png','bowtie1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','balloon1.png',
    'bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png',
    'hourglass1.png','scrunchie2.png','snowglobe1.png','hourglass2.png','snowglobe2.png','rug1.png','rug2.png',
    'easteregg1.png','coatrack1.png','easteregg2.png','cushion1.png','coatrack2.png','cushion2.png',
    'necktie1.png','necktie2.png','coffeemug1.png','chessboard1.png','coffeemug2.png','balloon2.png','chessboard2.png'];
    const rightimgList = ['bowtie1.png','bowtie1.png','balloon1.png','bowtie1.png','bowtie1.png','balloon1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','bowtie1.png',
    'scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png',
    'hourglass1.png','scrunchie2.png','snowglobe1.png','hourglass2.png','snowglobe2.png','rug1.png','rug2.png',
    'easteregg1.png','coatrack1.png','easteregg2.png','cushion1.png','coatrack2.png','cushion2.png',
    'necktie1.png','necktie2.png','coffeemug1.png','chessboard1.png','coffeemug2.png','balloon2.png','chessboard2.png'];
    const leftoutcomeList = [1,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01];
    const rightoutcomeList = [0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,1];
    const totalTrialNumber = 312; // 12 (blocks) * 13 (trials) * 2 (reward/punishment conditions)
    window.totalBlockNumber = 24;
    // get PID
    // var PID = ;
    
    // ASSIGN CONDITIONS HERE BASED ON PID; 1 is no early stop & reward-punishment grouped, 2 is no early stop & punishment-reward grouped, 
    //                                      3 is early stop & reward-punishment grouped, 4 is early stop & punishment-reward grouped, 
    //                                      5 is no early stop & interleaved, 6 is early stop & interleaved

    // Conditions:
    // First digit - early stopping. 0 - no early stopping, 1 - early stopping
    // Second digit - valence grouped / interleaved. 0 - interleaved, 1 - grouped.
    // Third digit - reward first. 0 - punishment first, 1 - reward first, undefined - NA

    async function load_squences(condition, session) {
        try {
            const response = await fetch('PLT_task_structure_' + condition + '.json');
            if (!response.ok) {
            throw new Error('Network response was not ok');
            }
            const structure = await response.json();
            const sess_structure = structure[session - 1];
            run_full_experiment(sess_structure);
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }

    // Initialize jsPysch object
    let jsPsych = initJsPsych({
        display_element: 'display_element',
    });

    // Get condition from URL, all caps are prolific, lowercase are ours
    window.condition = jsPsych.data.getURLVariable('cond');
    window.prolificPID = jsPsych.data.getURLVariable('PROLIFIC_PID');
    window.studyId = jsPsych.data.getURLVariable('STUDY_ID');
    window.sessionId = jsPsych.data.getURLVariable('SESSION_ID');
    window.sessionNum = jsPsych.data.getURLVariable('session_num');

    // Parse condition
    window.earlyStop = window.condition[0] == "1"
    window.valenceGrouped = window.condition[1] == "1"
    window.rewardFirst = window.condition[2] == "1"

    // Save participant variables to data
    jsPsych.data.addProperties({
        prolific_pid: window.prolificPID,
        study_id: window.studyId,
        session_id: window.sessionId,
        condition: window.condition,
        early_stop: window.earlyStop,
        valence_grouped: window.valenceGrouped,
        reward_first: window.rewardFirst
    })

    window.skipThisBlock = false;
    window.accNumber = 0;
    window.blockNumber = 1;
    window.interimOutcome = 0;
    
    inter_block_msg = {
        type: jsPsychHtmlKeyboardResponse,
        choices: ['s'],
        stimulus: function(){
            if (earlyStop & window.skipThisBlock){
                return "You've clearly identified the optimal card.<br><br>You will now see two new cards.<br><br>Press S key to continue.";
            }else{
                return "New round! You will see two new cards!";
            }
        },
        data: {
            trialphase: "break",
        },
        on_finish: (data) => {
            data.earlybreak = window.skipThisBlock;
            window.skipThisBlock = false;
            window.accNumber = 0;
            window.interimOutcome = 0;
        }
    }

    inter_valence_msg = [
        {
            type: jsPsychHtmlKeyboardResponse,
            choices: ['space'],
            stimulus: function(){
                if ((window.rewardFirst & window.sessionNum == 1) | ((!window.rewardFirst) & window.sessionNum == 2)) {
                    return "<p>Well done.</p><p>You will now continue playing the Card Collector's Challenge, \
                        but this time to <b>avoid losing coins</b>. To start this part of the challenge, you recieve a purse with \
                        Â£x in coins. Every broken coin you discover will be deducted from your purse.</p>\
                        <p>Your goal is to lose as few coins as possible. Your bonus payment will be based on the number of \
                            coins you have left at the end of the challenge.</p>\
                            <p>Press the space bar to continue.</p>"
                } else {
                    return "<p>Well done.</p><p>You will now continue playing the Card Collector's Challenge, \
                        but this time to <b>win coins</b>.</p>\
                        <p>Your goal is to win as many coins as possible. Your bonus payment will be based on the number of \
                            coins you have at the end of the challenge.</p>\
                            <p>Press the space bar to continue.</p>"
                }
            },
            data: {
                trialphase: "change_valence",
            },
            on_finish: (data) => {
                data.earlybreak = window.skipThisBlock;
                window.skipThisBlock = false;
                window.accNumber = 0;
                window.interimOutcome = 0;
            }
        },
        {
            type: jsPsychHtmlKeyboardResponse,
            choice: ['d', 'k'],
            stimulus: "<p>Place your fingers on the keyboard as shown below, and press either the 'F' or 'K' key to start playing again.</p>",
            data: {
                trialphase: "change_valence"
            }
        }
    ]

    PLT_trial =  {
        timeline: [{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px">+</div>',
            choices: "NO_KEYS",
            trial_duration: 800,
            data: {trialphase: "fixation"},
        },
        {
            type: jsPsychPLT,
            imgLeft: function() {'imgs/'+ jsPsych.timelineVariable('stimulus_left')},
            imgRight: function() {'imgs/'+ jsPsych.timelineVariable('stimulus_right')},
            outcomeLeft: jsPsych.timelineVariable('feedback_left'),
            outcomeRight: jsPsych.timelineVariable('feedback_left'),
            optimalRight: jsPsych.timelineVariable('optimal_right'),
            data: {
                trialphase: "task",
            },
            on_finish: function(data) {
                if (data.isOptimal) {
                    window.accNumber++;
                } else {
                    window.accNumber = 0;
                }
                if (window.accNumber === 5){
                    if (earlyStop){
                        window.skipThisBlock = true
                    }
                }
                data.blockNumber = window.blockNumber;
                window.interimOutcome = window.interimOutcome + data.chosenOutcome;
                console.log(window.accNumber)
            }
        }
        ],
        conditional_function: function(){
            return !window.skipThisBlock
        }
    } 
    
    function build_PLT_task(structure){
        let PLT_task = [];
        for (let i=0; i < window.totalBlockNumber; i++){
            block = [
                {
                    timeline: [PLT_trial],
                    timeline_variables: structure[i]
                }
            ];
            
            // Add message
            if (window.valenceGrouped & (i == (totalBlockNumber / 2 - 1))) {
                block.push(inter_valence_msg);
            } else {
                block.push(inter_block_msg);
            }
            
            PLT_task = PLT_task.concat(block)
        }

        return PLT_task
    }

    function run_full_experiment(structure){
        
        // Add instructions
        let procedure = prepare_instructions();

        // Add PLT
        // procedure = procedure.concat(build_PLT_task(structure));

        // Final messages and data saving
        procedure.push({                
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "Well done! You have finished the experiment.",
            data: {trialphase: "end"},
            on_start: () => {
                var jspsych_data = jsPsych.data.get().json();

                var redcap_record = JSON.stringify([{
                    Record_id: 1, // Mandatory, but ignored by REDcap
                    prolific_pid: window.prolificPID,
                    study_id: window.studyId,
                    session_id: window.sessionId,
                    start_time: window.startTime,
                    exp_code_version: code_version,
                    group: window.condition,
                    jspsych_data: jspsych_data
                }])

                fetch('https://2nqlv48ck0.execute-api.eu-north-1.amazonaws.com/prod/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: redcap_record
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Data successfully submitted to REDCap');
                    } else {
                        console.error('Error submitting data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        })

        // Run
        jsPsych.run(procedure);
    }

    load_squences(window.condition, window.sessionNum);
        
</script>
</html>