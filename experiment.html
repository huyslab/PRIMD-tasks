<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLT</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-call-function.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="plugin-PLT.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .jsPsychDE {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: whitesmoke;
    }
</style>
<body>
    <div id='display_element' class='jsPsychDE'></div>
</body>
<script>
    // SET UP MULTIPLE IMAGE LISTS AND OUTCOME LISTS FOR DIFFERENT CONDITIONS HERE
    const leftimgList = ['balloon1.png','balloon1.png','bowtie1.png','balloon1.png','balloon1.png','bowtie1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','balloon1.png',
    'bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png',
    'hourglass1.png','scrunchie2.png','snowglobe1.png','hourglass2.png','snowglobe2.png','rug1.png','rug2.png',
    'easteregg1.png','coatrack1.png','easteregg2.png','cushion1.png','coatrack2.png','cushion2.png',
    'necktie1.png','necktie2.png','coffeemug1.png','chessboard1.png','coffeemug2.png','balloon2.png','chessboard2.png'];
    const rightimgList = ['bowtie1.png','bowtie1.png','balloon1.png','bowtie1.png','bowtie1.png','balloon1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','balloon1.png','bowtie1.png','bowtie1.png',
    'scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png','scrunchie1.png','bowtie2.png','scrunchie1.png','scrunchie1.png','bowtie2.png','scrunchie1.png','bowtie2.png','bowtie2.png',
    'hourglass1.png','scrunchie2.png','snowglobe1.png','hourglass2.png','snowglobe2.png','rug1.png','rug2.png',
    'easteregg1.png','coatrack1.png','easteregg2.png','cushion1.png','coatrack2.png','cushion2.png',
    'necktie1.png','necktie2.png','coffeemug1.png','chessboard1.png','coffeemug2.png','balloon2.png','chessboard2.png'];
    const leftoutcomeList = [1,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01];
    const rightoutcomeList = [0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,0.5,0.01,1,0.01,0.01,0.01,0.01,0.5,1,0.01,0.5,1,0.5,1,0.01,0.5,0.01,0.5,1,0.5,1,0.01,0.01,1,0.01,0.01,0.01,0.01,1];
    const totalTrialNumber = 312; // 12 (blocks) * 13 (trials) * 2 (reward/punishment conditions)
    const totalBlockNumber = 24;
    // get PID
    // var PID = ;
    
    // ASSIGN CONDITIONS HERE BASED ON PID; 1 is no early stop & reward-punishment grouped, 2 is no early stop & punishment-reward grouped, 
    //                                      3 is early stop & reward-punishment grouped, 4 is early stop & punishment-reward grouped, 
    //                                      5 is no early stop & interleaved, 6 is early stop & interleaved

    // Conditions:
    // First digit - early stopping. 0 - no early stopping, 1 - early stopping
    // Second digit - valence grouped / interleaved. 0 - interleaved, 1 - grouped.
    // Third digit - reward first. 0 - punishment first, 1 - reward first, undefined - NA

    // Initialize jsPysch object
    let jsPsych = initJsPsych({
        display_element: 'display_element',
    });

    // Get condition from URL
    window.condition = jsPsych.data.getURLVariable('cond');
    window.prolificPID = jsPsych.data.getURLVariable('PROLIFIC_PID');
    window.studyId = jsPsych.data.getURLVariable('STUDY_ID');
    window.sessionId = jsPsych.data.getURLVariable('SESSION_ID');

    // Parse condition
    window.earlyStop = window.condition[0] == "1"
    window.valenceGrouped = window.condition[1] == "1"
    window.rewardFirst = window.condition[2] == "1"

    // Save participant variables to data
    jsPsych.data.addProperties({
        prolific_pid: window.prolificPID,
        study_id: window.studyId,
        session_id: window.sessionId,
        condition: window.condition,
        early_stop: window.earlyStop,
        valence_grouped: window.valenceGrouped,
        reward_first: window.rewardFirst
    })

    window.skipThisBlock = false;
    window.accNumber = 0;
    window.blockNumber = 1;
    window.interimOutcome = 0;
    
    let instructions = [
        {
        type: jsPsychInstructions,
        pages: [
            "<p><b>Welcome to The Card Collector's Challenge!</b></p>\
                <p>On each turn, the Card Collector will present you with two cards. \
                    The Card Collector has hidden a coin beneath each card. \
                    You get to choose which card to flip and reveal the coin underneath.</p>"
        ],
        show_clickable_nav: true,
        data: {trialphase: "instruction"}
    },
    {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Let's try it out! Two cards will appear on the next screen. \
                Use the 'F' key to choose the left card, or the 'K' key to choose the right card.</p>\
                <p>Place your fingers on the keyboard as shown below, and press either the 'F' or 'K' key to continue.</p>",
        chioces: ['d', 'k'],
        data: {trialphase: "instruction"}
    },
    {
        type: jsPsychInstructions,
        pages: [
            "<p>Well done! You found a one-pound coin.</p>",
            "<p>The Card Collector uses 1 penny coins, 50 pence coins, and 1-pound coins. \
                Usually, the 50 pence or 1-pound coin is hidden under the same card each time, \
                while the penny is under the other card. However, they sometimes mix it up.</p>\
            <p>Your goal is to collect as many valuable coins as possible by figuring out which card usually hides the better coins. \
                When you complete the game, you will receive bonus money based on the value of the coins you collected.</p>",
            "<p>There are two versions of The Card Collector's Challenge:</p>\
            <p>1. <b>Winning Coins</b>: You start with no coins and keep each coin you find.<br>\
               2. <b>Avoiding Losses</b>: You start with a purse of coins. \
               Each card you flip reveals a broken coin, which is removed from your purse. \
               If you find a broken penny, you lose a penny; if you find a broken 50 pence, \
               you lose 50 pence; and if you find a broken pound, you lose one pound.<p>",
            "<p>In both versions, your goal is to finish with as many coins as possible. \
                The number of coins you have will determine your bonus money.</p>"
        ],
        show_clickable_nav: true,
        data: {trialphase: "instruction"}
    },
    {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Let's practice both versions. We'll start with winning coins. \
            You begin with zero coins. Try to collect as many as you can.</p>\
            <p>Place your fingers on the keyboard as shown below, and press either the 'F' or 'K' key to continue.</p>",
        chioces: ['d', 'k'],
        data: {trialphase: "instruction"}
    },
    {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Well done! You would have earned £X in this game.</p>\
        <p>Now, let's practice avoiding losses. You'll start with £Y of coins. Try to lose as few as possible.</p>\
        <p>Place your fingers on the keyboard as shown below, and press either the 'F' or 'K' key to continue.</p>",
        chioces: ['d', 'k'],
        data: {trialphase: "instruction"}
    },
    {
        type: jsPsychInstructions,
        pages: function() {
            let pages = [
                "<p>Well done! You would have earned £X in this game.</p>"
            ];

            if (window.earlyStop) {
                pages.push("<p>To save time, if you select the better card five times in a row, \
            the game will end, and you will get all the remaining coins as if you \
            had chosen the better card each time.</p>");
            }

            let final_page = "<p>You are almost ready to play for real.</p>\
                <p>You will play multiple rounds of The Card Collector's Challenge.";
            
            if (window.valenceGrouped){
                if (window.rewardFirst){
                    final_page += "At first you'll play " +  totalBlockNumber / 2 + 
                        " rounds to win coins, and then another " +  totalBlockNumber / 2 + 
                        " rounds to avoid losing coins.</p>";
                } else {
                    final_page += "At first you'll play " +  totalBlockNumber / 2 + 
                        " rounds to avoid losing coins, and then another " +  totalBlockNumber / 2 + 
                        " rounds to win coins. You start the game with £x of coins.</p>";
                }
            } else {
                final_page += "You will play  " +  totalBlockNumber  + 
                        " rounds, sometimes to win coins, and sometimes to avoid losing them.<br>\
                        You start the game with £x of coins. ";
            }
            
            pages.push(final_page);

            return(pages)
        },
        show_clickable_nav: true,
        data: {trialphase: "instructions"}
    }
]
    
    function make_bandit_trial(leftimage, rightimage, leftoutcome, rightoutcome) {
        return {
            timeline: [{
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '<div style="font-size:60px">+</div>',
                choices: "NO_KEYS",
                trial_duration: 800,
                data: {trialphase: "fixation"},
            },{ // select the correct list based on the condition
                type: jsPsychPLT,
                imgLeft: 'imgs/'+leftimage,
                imgRight: 'imgs/'+rightimage,
                outcomeLeft: leftoutcome,
                outcomeRight: rightoutcome,
                data: {
                    trialphase: "task",
                },
                on_finish: function(data) {
                    if (data.isOptimal) {
                        window.accNumber++;
                    } else {
                        window.accNumber = 0;
                    }
                    if (window.accNumber === 5){
                        if (earlyStop){
                            window.skipThisBlock = true
                        }
                    }
                    data.blockNumber = window.blockNumber;
                    window.interimOutcome = window.interimOutcome + data.chosenOutcome;
                    console.log(window.accNumber)
                }
            }
            ],
            conditional_function: function(){
                return !window.skipThisBlock
            }
        }
    } 

    function draw_break(){
        if (!earlyStop) {
            return {
                timeline:[{
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "New round! You will see two new cards!",
                    data: {
                        trialphase: "break",
                    },
                    on_finish: (data)=>{
                        data.earlybreak = window.skipThisBlock;
                        data.blockNumber = window.blockNumber;
                        window.blockNumber++; 
                    },
                }]
            }
        } else if (earlyStop){
            return {
                timeline:[{
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: ()=>{
                        if (window.skipThisBlock){
                            return "You've clearly identified the optimal card.<br><br>You will now see two new cards.<br><br>Press S key to continue.";
                            // return `<p>You've clearly identified the optimal card. You have obtained ${window.interimOutcome} points.<br><br>You will now see two new cards.<br><br>Press S key to continue.</p>`;
                        } else {
                            return "New round! You will see two new cards.";
                        }
                    },
                    data: {
                        trialphase: "break",
                    },
                    on_finish: function(data){
                        data.earlybreak = window.skipThisBlock;
                        window.skipThisBlock = false;
                        window.accNumber = 0;
                        data.blockNumber = window.blockNumber;
                        window.blockNumber++;
                        window.interimOutcome = 0;
                    }
                }]
            }
        }
    }
    
    let bandit_block = [];
    let trialNumber = 0;
    for (let i = 0; i < totalTrialNumber; i++){
        let leftimage = leftimgList.shift();
        let rightimage = rightimgList.shift();
        let leftoutcome = leftoutcomeList.shift();
        let rightoutcome = rightoutcomeList.shift();
        trialNumber ++;

        bandit_block.push(make_bandit_trial(leftimage, rightimage, leftoutcome, rightoutcome));
        
        if (trialNumber % 13 ==0) {
            bandit_block.push(draw_break());
        }
        // new instructions for the grouped conditions
        if ((trialNumber) === 156) {
            if (window.condition === "011") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of taking away your coins in this game.<br><br>Your goal is to figure out which of the two cards COSTS you the most coins, and AVOID LOSING the coins as best as your can over time.<br><br>Upon your selection, you will see a picture of a broken coin, indicating the amount you have lost from that selection.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            } else if (window.condition === "111") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of taking away your coins in this game.<br><br>Your goal is to figure out which of the two cards COSTS you the most coins, and AVOID LOSING the coins as best as your can over time.<br><br>Upon your selection, you will see a picture of a broken coin, indicating the amount you have lost from that selection.<br><br>If you choose the better card five times in a row within a round, you will be able to skip to the next round of game immediately.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            } else if (window.condition === "010") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of giving you coins.<br><br>Your goal is to figure out which of the two cards GIVES you the most coins, and COLLECT as many coins as possible over time.<br><br>Upon your selection, you will see a picture of a coin, indicating the amount you have earned from that selection.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            } else if (window.condition === "110") {
                bandit_block.push({
                    type: jsPsychHtmlKeyboardResponse,
                    choices: ['s'],
                    stimulus: "CHANGES IN THE INSTRUCTION! Please read carefully.<br><br>In the following rounds, you will see two cards on each turn.<br><br>Each card has its own unique probability of giving you coins.<br><br>Your goal is to figure out which of the two cards GIVES you the most coins, and COLLECT as many coins as possible over time.<br><br>Upon your selection, you will see a picture of a coin, indicating the amount you have earned from that selection.<br><br><br>Press S key to continue!</p>",
                    data: {trialphase: "changeInstruction"},
                })
            }
        }
    }
    
    let procedure = [];
    procedure = procedure.concat(instructions);
    procedure.push({ timeline: bandit_block});
    procedure.push({                
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "Well done! You have finished the experiment.",
        data: {trialphase: "end"},
        on_start: () => {
            jsPsych.data.get().localSave('csv', `PLT_data.csv`);
        }
    })

    jsPsych.run(procedure);
    
</script>
</html>