<!DOCTYPE html>
<html>

<head>
  <title>Box Shaking Experiment</title>
  <script src="jspsych/jspsych.js"></script>
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    #experiment-container {
      width: 100px;
      height: 180px;
      /* Increased to accommodate space below the box */
      margin: 20px auto;
      position: relative;
    }

    #box {
      width: 100px;
      height: 100px;
      background-color: #f0f0f0;
      border: 2px solid #000;
      transition: transform 0.1s;
      position: absolute;
      top: 0;
      left: 0;
    }

    #coin-container {
      width: 100px;
      height: 80px;
      position: absolute;
      top: 100px;
      /* Position it right below the box */
      left: 0;
      pointer-events: none;
    }

    .coin {
      width: 20px;
      height: 20px;
      background-color: gold;
      border-radius: 50%;
      position: absolute;
      top: 0;
      /* Start at the top of the coin container */
      opacity: 0;
    }

    @keyframes dropCoin {
      0% {
        transform: translateY(0);
        opacity: 1;
      }

      /* 60% { transform: translateY(60px); opacity: 1; } */
      80% {
        transform: translateY(60px);
        opacity: 1;
      }

      100% {
        transform: translateY(60px);
        opacity: 0.5;
      }
    }

    .coin-drop {
      animation: dropCoin 0.5s ease-in-out;
    }
  </style>
</head>

<body>
  <div id="jspsych-content"></div>
  <script>
    const jsPsych = initJsPsych({
      on_finish: function () {
        jsPsych.data.displayData();
      }
    });

    // Configuration object
    const experimentConfig = {
      ratios: [1, 2, 4, 8, 32, 64],
      magnitudes: [1, 2, 5, 10, 20, 50, 100, 200],
      trialDuration: 1000, // in milliseconds
      minITI: 1400,
      maxITI: 1600
    };

    window.totalReward = 0;
    window.totalPresses = 0;

    // Generate trials
    function generateTrials() {
      let trials = [];
      for (let magnitude of experimentConfig.magnitudes) {
        for (let ratio of experimentConfig.ratios) {
          trials.push({ magnitude, ratio });
        }
      }
      return jsPsych.randomization.shuffle(trials);
    }

    // Trial stimulus function
    function generateTrialStimulus(magnitude, ratio) {
      return `
        <div id="experiment-container">
            <div id="box"></div>
            <div id="coin-container"></div>
        </div>
        <div id="reward-counter">Total Reward: ${totalReward}</div>
        <div id="trial-info">Magnitude: ${magnitude}, Ratio: ${ratio}</div>
    `;
    }

    // Functions for animation

    function shakeBox() {
      const box = document.getElementById('box');
      box.style.transform = 'translateX(-5px)';
      setTimeout(() => {
        box.style.transform = 'translateX(5px)';
        setTimeout(() => {
          box.style.transform = 'translateX(0)';
        }, 50);
      }, 50);
    }

    function dropCoin() {
      const coinContainer = document.getElementById('coin-container');
      const coin = document.createElement('div');
      coin.className = 'coin';

      // Random horizontal position
      // const randomLeft = Math.random() * 20 + 40; // Random value between 20 and 80
      const randomLeft = 40;
      coin.style.left = `${randomLeft}px`;

      coinContainer.appendChild(coin);

      // Trigger the animation
      setTimeout(() => {
        coin.classList.add('coin-drop');
        // Remove the coin element after animation
        coin.addEventListener('animationend', () => {
          coin.remove();
        });
      }, 50);
    }

    // Box shaking trial
    const boxShakingTrial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function () {
        return generateTrialStimulus(jsPsych.evaluateTimelineVariable('magnitude'), jsPsych.evaluateTimelineVariable('ratio'));
      },
      choices: 'NO_KEYS',
      // response_ends_trial: false,
      trial_duration: experimentConfig.trialDuration,
      save_timeline_variables: true,
      data: {
        trial_presses: () => {return window.trialPresses},
        trial_reward: () => {return window.trialReward},
        response_time: () => {return window.responseTime},
        // Record global data
        total_presses: () => {return totalPresses},
        total_reward: () => {return totalReward}
      },
      on_start: function (trial) {
        // Create a shared state object
        window.trialPresses = 0;
        window.trialReward = 0;
        window.responseTime = [];

        let lastPressTime = 0;
        let pressCount = 0;
        
        const ratio = jsPsych.evaluateTimelineVariable('ratio');
        const magnitude = jsPsych.evaluateTimelineVariable('magnitude');

        const keyboardListener = jsPsych.pluginAPI.getKeyboardResponse({
          callback_function: function(info) {
            window.responseTime.push(info.rt - lastPressTime);
            lastPressTime = info.rt;
            shakeBox();
            pressCount++;
            window.trialPresses++;
            window.totalPresses++;

            if (pressCount === ratio) {
              window.trialReward += magnitude;
              window.totalReward += magnitude;
              document.getElementById('reward-counter').innerHTML = `Total Reward: ${window.totalReward}`;
              pressCount = 0;
              dropCoin();
            }
          },
          valid_responses: [' '],
          rt_method: 'performance',
          persist: true,
          allow_held_key: false,
          minimum_valid_rt: 50
        });
      },
      on_finish: function (data) {
        // Clean up listener
        jsPsych.pluginAPI.cancelAllKeyboardResponses();
      }
    };

    // Inter-trial interval
    const interTrialInterval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function () {
        return `
            <div>Preparing next trial...</div>
            <div id="reward-counter">Total Reward: ${window.totalReward}</div>
        `;
      },
      choices: "NO_KEYS",
      on_start: function (trial) {
        trial.trial_duration = Math.floor(Math.random() * (experimentConfig.maxITI - experimentConfig.minITI) + experimentConfig.minITI);
      },
      save_trial_parameters: {trial_duration: true}
    };

    // Create timeline
    // Instructions
    const instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p>Welcome to the Box Shaking Experiment!</p>
        <p>In this experiment, you will see a box on the screen.</p>
        <p>Your task is to press the spacebar to shake the box.</p>
        <p>Sometimes, shaking the box will result in a coin dropping.</p>
        <p>The number of shakes needed for a coin to drop and the value of the coin will change throughout the experiment.</p>
        <p>Try to earn as many points as possible!</p>
        <p>Each trial will last for 6 seconds, followed by a short break.</p>
        <p>Press the button below when you're ready to begin.</p>
    `,
      choices: ['Start Experiment']
    };

    // Generate trials
    const trials = generateTrials();

    // Create main experiment timeline
    const experimentTimeline = [];
    trials.forEach(trial => {
      experimentTimeline.push({
        timeline: [boxShakingTrial, interTrialInterval],
        timeline_variables: [trial]
      });
    });

    // Debriefing
    const debriefing = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        return `
            <p>Thank you for participating in the experiment!</p>
            <p>You earned a total of ${totalReward} points.</p>
            <p>In this experiment, we were studying how different reward schedules and magnitudes affect behavior.</p>
            <p>Sometimes you needed more shakes to get a reward, and sometimes the rewards were larger.</p>
            <p>Your data will help us understand how people respond to different patterns of reinforcement.</p>
            <p>If you have any questions about the experiment, please ask the experimenter now.</p>
        `;
      },
      choices: ['Finish']
    };

    // Combine all parts into the full timeline
    const fullTimeline = [
      instructions,
      ...experimentTimeline.slice(0, 2),
      debriefing
    ];

    // Run the experiment
    jsPsych.run(fullTimeline);
  </script>
</body>

</html>